<div class="container mt-4">

    <a href="/boroughs" class="btn btn-secondary mb-3">← Back to Boroughs List</a>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">{{borough.name}}</h1>
        {{!--Community feedback: Like/Unlike button for authenticated users --}}
        {{#if isAuthenticated}}
        <button id="like-button" data-borough-id="{{borough._id}}"
            class="btn btn-lg {{#if isLiked}}btn-danger{{else}}btn-outline{{/if}}">
            <i class="fas fa-heart"></i>
            <span id="like-status">{{#if isLiked}}Liked!{{else}}Like This Borough{{/if}}</span>
        </button>
        {{/if}}
    </div>
    <p class="lead">{{borough.description}}</p>

    <hr>

    {{#with borough.stats.[0]}}

    {{#if (or (gt avg_chlorine 4.0) (gt avg_turbidity 5.0) (gt avg_e_coli 0.0))}}
    <div class="alert alert-warning"
        style="background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <p style="margin-top: 0; font-weight: 600;">⚠️ Health Tip: Elevated Water Indicators Detected.</p>
        <ul>
            {{#if (gt avg_chlorine 4.0)}}
            <li><strong>Chlorine Alert</strong>: Average free chlorine ({{toFixed3 avg_chlorine}} mg/L) is high. May
                affect taste or smell.</li>
            {{/if}}
            {{#if (gt avg_turbidity 5.0)}}
            <li><strong>Turbidity Alert</strong>: Average turbidity ({{toFixed3 avg_turbidity}} NTU) is slightly high.
            </li>
            {{/if}}
            {{#if (gt avg_e_coli 0.0)}}
            <li style="color: #dc3545;"><strong>E. Coli Warning</strong>: E. Coli was detected ({{toFixed3 avg_e_coli}}
                MPN/100mL). Follow local health guidelines.</li>
            {{/if}}
        </ul>
    </div>
    {{else}}
    <div class="alert alert-success"
        style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <p style="margin: 0; font-weight: 600;">Health Tip: Water quality is within standard guidelines.</p>
    </div>
    {{/if}}
    {{/with}}

    <h3>Borough Statistics</h3>

    {{#if borough.stats.[0]}}
    <ul class="list-group mb-4">
        <li class="list-group-item">
            <strong>Avg Chlorine:</strong> {{toFixed3 borough.stats.[0].avg_chlorine}} mg/L
        </li>
        <li class="list-group-item">
            <strong>Avg Turbidity:</strong> {{toFixed3 borough.stats.[0].avg_turbidity}} NTU
        </li>
        <li class="list-group-item">
            <strong>Avg Coliform:</strong> {{toFixed3 borough.stats.[0].avg_coliform}} MPN/100mL
        </li>
        <li class="list-group-item">
            <strong>Avg E. Coli:</strong> {{toFixed3 borough.stats.[0].avg_e_coli}} MPN/100mL
        </li>
        <li class="list-group-item">
            <strong>Avg Fluoride:</strong> {{toFixed3 borough.stats.[0].avg_fluoride}} mg/L
        </li>
    </ul>
    {{else}}
    <p><em>No statistics available for this borough.</em></p>
    {{/if}}

    <hr>

    {{!-- Comment posting and comment list--}}
    <section id="comments-section" class="mt-5">
        <h2>Community Feedback ({{comments.length}})</h2>

        {{#if isAuthenticated}}
        <div id="add-comment-form-container">
            <form id="comment-form" data-borough-id="{{borough._id}}">
                <div class="form-group">
                    <label for="comment-text">Leave a Comment (max 200 chars):</label>
                    <textarea class="form-control" id="comment-text" name="comment" rows="3" maxlength="200"
                        required></textarea>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Post Comment</button>
                <div id="comment-error" class="error-text hidden mt-2"></div>
            </form>
        </div>
        {{else}}
        <p class="text-muted mt-3">Please <a href="/users/login">login</a> to post a comment and share your feedback.
        </p>
        {{/if}}

        <ul id="comment-list" class="list-group mt-4">
            {{#each comments}}
            <li class="list-group-item" data-comment-id="{{this._id}}">
                <p>{{this.comment}}</p>
                <small class="text-muted">
                    Posted by
                    {{#if this.user}}
                    <strong>{{this.user.fname}} {{this.user.lname}}</strong>
                    {{else}}
                    <span class="text-danger">Deleted User</span>
                    {{/if}}
                    on {{this.commentDate}}
                </small>

                {{!-- Admin or user Delete Button --}}
                {{#if ../isAuthenticated}}
                {{#with ../currentUser}}
                {{#if (or (eq this.role 'admin') (eq this.id ../this.user._id))}}
                <button class="btn btn-sm btn-danger delete-comment-btn" data-comment-id="{{../this._id}}"
                    style="float: right; padding: 4px 8px; font-size: 12px;">
                    Delete
                </button>
                {{/if}}
                {{/with}}
                {{/if}}
            </li>
            {{/each}}
        </ul>

        {{#unless (gt (len comments) 0)}}
        <p class="text-muted mt-3">Be the first to leave a comment!</p>
        {{/unless}}
    </section>

</div>

<script src="/public/js/like.js"></script>
<script src="/public/js/comments.js"></script>
`